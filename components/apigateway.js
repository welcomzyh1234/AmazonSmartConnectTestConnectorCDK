"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@aws-cdk/core");
const apiGateway = require("@aws-cdk/aws-apigateway");
class APIGatewayConstruct extends core_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        new apiGateway.CfnAccount(this, 'Account', {
            cloudWatchRoleArn: props.cloudWatchRoleArn
        });
        this.api = new apiGateway.RestApi(this, 'Api', {
            restApiName: props.apiName,
            endpointConfiguration: {
                types: [props.endpointType]
            },
            cloudWatchRole: false // will use exising role <props.cloudWatchRoleArn>
        });
    }
    addInventoriesResource(lambdaFunction) {
        const resource = this.addCorsResource(this.api.root, 'inventories');
        resource.addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        resource.addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
    }
    addPricesResource(lambdaFunction) {
        const resource = this.addCorsResource(this.api.root, 'prices');
        resource.addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
    }
    addOrderResource(lambdaFunction) {
        const resource = this.addCorsResource(this.api.root, 'orders');
        this.addCorsResource(resource, 'get-order').addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'list-orders').addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'confirm-order').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'create-packages').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'generate-invoice').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'generate-ship-label').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'regenerate-ship-label').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'reject-order').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'retrieve-invoice').addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'retrieve-pickup-slots').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'retrieve-ship-label').addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'ship-order').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
        this.addCorsResource(resource, 'update-packages').addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
    }
    addEventsResource(lambdaFunction) {
        const eventsResource = this.addCorsResource(this.api.root, 'events');
        const subscriptionsResource = this.addCorsResource(eventsResource, 'subscriptions');
        subscriptionsResource.addMethod('GET', new apiGateway.LambdaIntegration(lambdaFunction));
        subscriptionsResource.addMethod('POST', new apiGateway.LambdaIntegration(lambdaFunction));
        subscriptionsResource.addMethod('DELETE', new apiGateway.LambdaIntegration(lambdaFunction));
        subscriptionsResource.addMethod('PUT', new apiGateway.LambdaIntegration(lambdaFunction));
    }
    addCorsResource(parentResource, resourceName) {
        const resource = parentResource.addResource(resourceName);
        this.addCorsOptions(resource);
        return resource;
    }
    addCorsOptions(apiResource) {
        apiResource.addMethod('OPTIONS', new apiGateway.MockIntegration({
            integrationResponses: [{
                    statusCode: '200',
                    responseParameters: {
                        'method.response.header.Access-Control-Allow-Headers': "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent,X-Amz-Access-Token'",
                        'method.response.header.Access-Control-Allow-Origin': "'*'",
                        'method.response.header.Access-Control-Allow-Credentials': "'false'",
                        'method.response.header.Access-Control-Allow-Methods': "'OPTIONS,GET,PUT,POST,DELETE'",
                    },
                }],
            passthroughBehavior: apiGateway.PassthroughBehavior.NEVER,
            requestTemplates: {
                "application/json": "{\"statusCode\": 200}"
            },
        }), {
            methodResponses: [
                {
                    statusCode: '200',
                    responseParameters: {
                        'method.response.header.Access-Control-Allow-Headers': true,
                        'method.response.header.Access-Control-Allow-Methods': true,
                        'method.response.header.Access-Control-Allow-Credentials': true,
                        'method.response.header.Access-Control-Allow-Origin': true,
                    },
                }
            ]
        });
    }
}
exports.APIGatewayConstruct = APIGatewayConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpZ2F0ZXdheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwaWdhdGV3YXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx3Q0FBMEM7QUFFMUMsc0RBQXNEO0FBU3RELE1BQWEsbUJBQW9CLFNBQVEsZ0JBQVM7SUFHaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUErQjtRQUN2RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksVUFBVSxDQUFDLFVBQVUsQ0FDdkIsSUFBSSxFQUNKLFNBQVMsRUFDVDtZQUNFLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxpQkFBaUI7U0FDM0MsQ0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQy9CLElBQUksRUFDSixLQUFLLEVBQ0w7WUFDRSxXQUFXLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDMUIscUJBQXFCLEVBQUU7Z0JBQ3JCLEtBQUssRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7YUFDNUI7WUFDRCxjQUFjLEVBQUUsS0FBSyxDQUFDLGtEQUFrRDtTQUN6RSxDQUNGLENBQUM7SUFDSixDQUFDO0lBRU0sc0JBQXNCLENBQUMsY0FBK0I7UUFDM0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUVwRSxRQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQzVFLFFBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksVUFBVSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVNLGlCQUFpQixDQUFDLGNBQStCO1FBQ3RELE1BQU0sUUFBUSxHQUFHLElBQUks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RUFBRSxLQUFLO3dCQUMzRCx5REFBeUQsRUFBRSxTQUFTO3dCQUNwRSxxREFBcUQsRUFBRSwrQkFBK0I7cUJBQ3ZGO2lCQUNGLENBQUM7WUFDRixtQkFBbUIsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsS0FBSztZQUN6RCxnQkFBZ0IsRUFBRTtnQkFDaEIsa0JBQWtCLEVBQUUsdUJBQXVCO2FBQzVDO1NBQ0YsQ0FBQyxFQUNGO1lBQ0UsZUFBZSxFQUFFO2dCQUNmO29CQUNFLFVBQVUsRUFBRSxLQUFLO29CQUNqQixrQkFBa0IsRUFBRTt3QkFDbEIscURBQXFELEVBQUUsSUFBSTt3QkFDM0QscURBQXFELEVBQUUsSUFBSTt3QkFDM0QseURBQXlELEVBQUUsSUFBSTt3QkFDL0Qsb0RBQW9ELEVBQUUsSUFBSTtxQkFDM0Q7aUJBQ0Y7YUFDRjtTQUNGLENBQ0YsQ0FBQTtJQUNILENBQUM7Q0FDRjtBQXpHRCxrREF5R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuXG5pbXBvcnQgKiBhcyBhcGlHYXRld2F5IGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVBJR2F0ZXdheUNvbnN0cnVjdFByb3BzIHtcbiAgcmVhZG9ubHkgYXBpTmFtZTogc3RyaW5nO1xuICByZWFkb25seSBlbmRwb2ludFR5cGU6IGFwaUdhdGV3YXkuRW5kcG9pbnRUeXBlO1xuICByZWFkb25seSBjbG91ZFdhdGNoUm9sZUFybjogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQVBJR2F0ZXdheUNvbnN0cnVjdCBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBhcGk6IGFwaUdhdGV3YXkuUmVzdEFwaTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQVBJR2F0ZXdheUNvbnN0cnVjdFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIG5ldyBhcGlHYXRld2F5LkNmbkFjY291bnQoXG4gICAgICB0aGlzLFxuICAgICAgJ0FjY291bnQnLFxuICAgICAge1xuICAgICAgICBjbG91ZFdhdGNoUm9sZUFybjogcHJvcHMuY2xvdWRXYXRjaFJvbGVBcm5cbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5hcGkgPSBuZXcgYXBpR2F0ZXdheS5SZXN0QXBpKFxuICAgICAgdGhpcyxcbiAgICAgICdBcGknLFxuICAgICAge1xuICAgICAgICByZXN0QXBpTmFtZTogcHJvcHMuYXBpTmFtZSxcbiAgICAgICAgZW5kcG9pbnRDb25maWd1cmF0aW9uOiB7XG4gICAgICAgICAgdHlwZXM6IFtwcm9wcy5lbmRwb2ludFR5cGVdXG4gICAgICAgIH0sXG4gICAgICAgIGNsb3VkV2F0Y2hSb2xlOiBmYWxzZSAvLyB3aWxsIHVzZSBleGlzaW5nIHJvbGUgPHByb3BzLmNsb3VkV2F0Y2hSb2xlQXJuPlxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYWRkSW52ZW50b3JpZXNSZXNvdXJjZShsYW1iZGFGdW5jdGlvbjogbGFtYmRhLkZ1bmN0aW9uKSB7XG4gICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzLmFkZENvcnNSZXNvdXJjZSh0aGlzLmFwaS5yb290LCAnaW52ZW50b3JpZXMnKTtcblxuICAgIHJlc291cmNlLmFkZE1ldGhvZCgnR0VUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICByZXNvdXJjZS5hZGRNZXRob2QoJ1BVVCcsIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG4gIH1cblxuICBwdWJsaWMgYWRkUHJpY2VzUmVzb3VyY2UobGFtYmRhRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbikge1xuICAgIGNvbnN0IHJlc291cmNlID0gdGhpcy5hZGRDb3JzUmVzb3VyY2UodGhpcy5hcGkucm9vdCwgJ3ByaWNlcycpO1xuICAgIHJlc291cmNlLmFkZE1ldGhvZCgnUFVUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRPcmRlclJlc291cmNlKGxhbWJkYUZ1bmN0aW9uOiBsYW1iZGEuRnVuY3Rpb24pIHtcbiAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuYWRkQ29yc1Jlc291cmNlKHRoaXMuYXBpLnJvb3QsICdvcmRlcnMnKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ2dldC1vcmRlcicpLmFkZE1ldGhvZCgnR0VUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ2xpc3Qtb3JkZXJzJykuYWRkTWV0aG9kKCdHRVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHRoaXMuYWRkQ29yc1Jlc291cmNlKHJlc291cmNlLCAnY29uZmlybS1vcmRlcicpLmFkZE1ldGhvZCgnUFVUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ2NyZWF0ZS1wYWNrYWdlcycpLmFkZE1ldGhvZCgnUFVUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ2dlbmVyYXRlLWludm9pY2UnKS5hZGRNZXRob2QoJ1BVVCcsIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG4gICAgdGhpcy5hZGRDb3JzUmVzb3VyY2UocmVzb3VyY2UsICdnZW5lcmF0ZS1zaGlwLWxhYmVsJykuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHRoaXMuYWRkQ29yc1Jlc291cmNlKHJlc291cmNlLCAncmVnZW5lcmF0ZS1zaGlwLWxhYmVsJykuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHRoaXMuYWRkQ29yc1Jlc291cmNlKHJlc291cmNlLCAncmVqZWN0LW9yZGVyJykuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHRoaXMuYWRkQ29yc1Jlc291cmNlKHJlc291cmNlLCAncmV0cmlldmUtaW52b2ljZScpLmFkZE1ldGhvZCgnR0VUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ3JldHJpZXZlLXBpY2t1cC1zbG90cycpLmFkZE1ldGhvZCgnUFVUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcbiAgICB0aGlzLmFkZENvcnNSZXNvdXJjZShyZXNvdXJjZSwgJ3JldHJpZXZlLXNoaXAtbGFiZWwnKS5hZGRNZXRob2QoJ0dFVCcsIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG4gICAgdGhpcy5hZGRDb3JzUmVzb3VyY2UocmVzb3VyY2UsICdzaGlwLW9yZGVyJykuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHRoaXMuYWRkQ29yc1Jlc291cmNlKHJlc291cmNlLCAndXBkYXRlLXBhY2thZ2VzJykuYWRkTWV0aG9kKCdQVVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICB9XG5cbiAgcHVibGljIGFkZEV2ZW50c1Jlc291cmNlKGxhbWJkYUZ1bmN0aW9uOiBsYW1iZGEuRnVuY3Rpb24pIHtcbiAgICBjb25zdCBldmVudHNSZXNvdXJjZSA9IHRoaXMuYWRkQ29yc1Jlc291cmNlKHRoaXMuYXBpLnJvb3QsICdldmVudHMnKTtcbiAgICBjb25zdCBzdWJzY3JpcHRpb25zUmVzb3VyY2UgPSB0aGlzLmFkZENvcnNSZXNvdXJjZShldmVudHNSZXNvdXJjZSwgJ3N1YnNjcmlwdGlvbnMnKTtcbiAgICBzdWJzY3JpcHRpb25zUmVzb3VyY2UuYWRkTWV0aG9kKCdHRVQnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHN1YnNjcmlwdGlvbnNSZXNvdXJjZS5hZGRNZXRob2QoJ1BPU1QnLCBuZXcgYXBpR2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihsYW1iZGFGdW5jdGlvbikpO1xuICAgIHN1YnNjcmlwdGlvbnNSZXNvdXJjZS5hZGRNZXRob2QoJ0RFTEVURScsIG5ldyBhcGlHYXRld2F5LkxhbWJkYUludGVncmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG4gICAgc3Vic2NyaXB0aW9uc1Jlc291cmNlLmFkZE1ldGhvZCgnUFVUJywgbmV3IGFwaUdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24obGFtYmRhRnVuY3Rpb24pKTtcblxuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb3JzUmVzb3VyY2UocGFyZW50UmVzb3VyY2U6IGFwaUdhdGV3YXkuSVJlc291cmNlLCByZXNvdXJjZU5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IHJlc291cmNlID0gcGFyZW50UmVzb3VyY2UuYWRkUmVzb3VyY2UocmVzb3VyY2VOYW1lKTtcbiAgICB0aGlzLmFkZENvcnNPcHRpb25zKHJlc291cmNlKTtcbiAgICByZXR1cm4gcmVzb3VyY2U7XG4gIH1cblxuICBwcml2YXRlIGFkZENvcnNPcHRpb25zKGFwaVJlc291cmNlOiBhcGlHYXRld2F5LklSZXNvdXJjZSkge1xuICAgIGFwaVJlc291cmNlLmFkZE1ldGhvZChcbiAgICAgICdPUFRJT05TJyxcbiAgICAgIG5ldyBhcGlHYXRld2F5Lk1vY2tJbnRlZ3JhdGlvbih7XG4gICAgICAgIGludGVncmF0aW9uUmVzcG9uc2VzOiBbe1xuICAgICAgICAgIHN0YXR1c0NvZGU6ICcyMDAnLFxuICAgICAgICAgIHJlc3BvbnNlUGFyYW1ldGVyczoge1xuICAgICAgICAgICAgJ21ldGhvZC5yZXNwb25zZS5oZWFkZXIuQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6IFwiJ0NvbnRlbnQtVHlwZSxYLUFtei1EYXRlLEF1dGhvcml6YXRpb24sWC1BcGktS2V5LFgtQW16LVNlY3VyaXR5LVRva2VuLFgtQW16LVVzZXItQWdlbnQsWC1BbXotQWNjZXNzLVRva2VuJ1wiLFxuICAgICAgICAgICAgJ21ldGhvZC5yZXNwb25zZS5oZWFkZXIuQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogXCInKidcIixcbiAgICAgICAgICAgICdtZXRob2QucmVzcG9uc2UuaGVhZGVyLkFjY2Vzcy1Db250cm9sLUFsbG93LUNyZWRlbnRpYWxzJzogXCInZmFsc2UnXCIsXG4gICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogXCInT1BUSU9OUyxHRVQsUFVULFBPU1QsREVMRVRFJ1wiLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1dLFxuICAgICAgICBwYXNzdGhyb3VnaEJlaGF2aW9yOiBhcGlHYXRld2F5LlBhc3N0aHJvdWdoQmVoYXZpb3IuTkVWRVIsXG4gICAgICAgIHJlcXVlc3RUZW1wbGF0ZXM6IHtcbiAgICAgICAgICBcImFwcGxpY2F0aW9uL2pzb25cIjogXCJ7XFxcInN0YXR1c0NvZGVcXFwiOiAyMDB9XCJcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAge1xuICAgICAgICBtZXRob2RSZXNwb25zZXM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiAnMjAwJyxcbiAgICAgICAgICAgIHJlc3BvbnNlUGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAnbWV0aG9kLnJlc3BvbnNlLmhlYWRlci5BY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogdHJ1ZSxcbiAgICAgICAgICAgICAgJ21ldGhvZC5yZXNwb25zZS5oZWFkZXIuQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6IHRydWUsXG4gICAgICAgICAgICAgICdtZXRob2QucmVzcG9uc2UuaGVhZGVyLkFjY2Vzcy1Db250cm9sLUFsbG93LUNyZWRlbnRpYWxzJzogdHJ1ZSxcbiAgICAgICAgICAgICAgJ21ldGhvZC5yZXNwb25zZS5oZWFkZXIuQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9XG4gICAgKVxuICB9XG59Il19